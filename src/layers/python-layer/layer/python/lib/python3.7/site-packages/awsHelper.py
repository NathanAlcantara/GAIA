import json
import logging
import unicodedata
import os
import sys
import boto3
import datetime


OK_RESPONSE = {
    'statusCode': 200,
    'headers': {'Content-Type': 'application/json'},
    'body': json.dumps('ok')
}

ERROR_RESPONSE = {
    'statusCode': 400,
    'body': json.dumps('Oops, something went wrong!')
}


def AWS_ID():
    with open('environment.json', 'r') as arquivo:
        data = arquivo.read()

    jhon = json.loads(data)

    aws_account = jhon['AWS_ACCOUNT_ID']

    return aws_account


def Telegram_Token():
    with open('environment.json', 'r') as arquivo:
        data = arquivo.read()

    jhon = json.loads(data)

    aws_token = jhon['TELEGRAM_TOKEN']

    return aws_token


def AWS_Tenant():
    with open('environment.json', 'r') as arquivo:
        data = arquivo.read()

    jhon = json.loads(data)

    aws_tenant = jhon['TENANT']

    return aws_tenant


def publishSnsTopic(chatId, payload, snsName="send-telegram-response"):

    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    sns = boto3.client('sns')  # criamos um SNS para enviar

    my_session = boto3.session.Session()
    aws_reg = my_session.region_name  # nome da região

    with open('environment.json', 'r') as arquivo:
        data = arquivo.read()

    jhon = json.loads(data)

    aws_account = jhon['AWS_ACCOUNT_ID']
    tenant = jhon['TENANT']

    logger.info(aws_reg)
    logger.info(aws_account)

    # aqui é o log do que vamos mandar e para onde
    logger.info('Publicando mensagem: {} no sns: {}'.format(payload, snsName))

    # vamos formatar o json de saida

    PyJson = json.loads(payload)

    PyJson['chatId'] = chatId

    jhon = json.dumps(PyJson)

    logger.info('Publicando Json : {} no sns: {}'.format(jhon, snsName))

    # ajeitamos o sns nome correto
    arnSNS = 'arn:aws:sns:{}:{}:{}-{}'.format(
        aws_reg, aws_account, tenant, snsName)

    logger.info("Assim ficou a string do arnSNS: {}".format(arnSNS))
    # aqui envia a resposta
    response = sns.publish(TopicArn=arnSNS, Message=jhon)


def SaveTXTinBucket(fileString, extension, bucket_name):
    # salva arquivo no bucket e cria um link publico
    # expiração é em milisegundos

    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    file_name = 'down' + datetime.datetime.now().isoformat() + '.' + extension
    file_name = file_name.replace(" ", "")
    logger.info('vamos tentar salvar o arquivo')
    s3 = boto3.resource("s3")
    s3.Object(bucket_name, file_name).put(Body=fileString)
    s3.ObjectAcl(bucket_name, file_name).put(ACL='public-read')
    logger.info('o arquivo {} foi salvo no bucket {} '.format(
        file_name, bucket_name))
    s3_client = boto3.client('s3')
    return file_name
