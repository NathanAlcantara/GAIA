import json
import logging
import unicodedata
import os
import sys
import boto3

# sys.path.append(os.path.join(os.path.dirname(os.path.realpath(__file__)), "./vendored")

# import requests

# Logging is cool!
# logger=logging.getLogger()
# if logger.handlers:
#     for handler in logger.handlers:
#         logger.removeHandler(handler)
# logging.basicConfig(level=logging.INFO)

# logger=logging.getLogger()
# logger.setLevel(logging.INFO)


OK_RESPONSE = {
    'statusCode': 200,
    'headers': {'Content-Type': 'application/json'},
    'body': json.dumps('ok')
}

ERROR_RESPONSE = {
    'statusCode': 400,
    'body': json.dumps('Oops, something went wrong!')
}


def publishSnsTopic(chatId, payload, snsName="send-telegram-response"):

    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    sns = boto3.client('sns')  # criamos um SNS para enviar

    my_session = boto3.session.Session()
    aws_reg = my_session.region_name  # nome da regiao

    aws_account = boto3.client('sts').get_caller_identity().get(
        'Account')  # account id

    tenant = "guilherme"

    logger.info(aws_reg)
    logger.info(aws_account)

    # aqui Ã© o log do que vamos mandar e para onde
    logger.info('Publicando mensagem: {} no sns: {}'.format(payload, snsName))

    # vamos formatar o json de saida

    PyJson = json.loads(payload)

    PyJson['chatId'] = chatId

    jhon = json.dumps(PyJson)

    logger.info('Publicando Json : {} no sns: {}'.format(jhon, snsName))

    # ajeitamos o sns nome correto
    arnSNS = 'arn:aws:sns:{}:{}:{}-{}'.format(
        aws_reg, aws_account, tenant, snsName)

    logger.info("Assim ficou a string do arnSNS: {}".format(arnSNS))
    # aqui envia a resposta
    response = sns.publish(TopicArn=arnSNS, Message=jhon)
